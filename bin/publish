#!/bin/sh

set -e

HOST=`sed -n -e 's/deploy_host=\(.*\)/\1/p' config.ini`

if [ -z "$HOST" ]; then
  echo "Need to configure deploy_host in config.ini"
  exit 1
fi

mysqldump --opt ordure \
          brand department item page product redirect \
  gzip -9 > ~/rm/tmp/ordure.sql.gz

scp ~/rm/tmp/ordure.sql.gz $HOST:

ssh $HOST "(zcat ordure.sql.gz | /usr/local/mysql/bin/mysql ordure) && sudo -u sphinxsearch /usr/bin/indexer --rotate ordure"

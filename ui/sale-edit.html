<include href="header.html" />
<noscript>
  <div class="row">
    <div class="alert alert-danger col-md-push-3 col-md-6" role="alert">
      <strong>Warning!</strong> Sorry, but this won't work with JavaScript
      disabled. You'll need to enable it to proceed.
    </div>
  </div>
</noscript>
<div class="row">
  <div class="col-md-8">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">
          Sale <!--ko text: ("000000" + sale.id()).substr(-7) -->#<!--/ko-->
        </h3>
        <p>
          <small>
            Created: <!--ko text: sale.created --><!--/ko--> /
            Last Modified: <!--ko text: sale.modified --><!--/ko-->
          </small>
        </p>
        <p>
          <a data-bind="click: function() { editPerson(sale) }"><i class="fa fa-user-o fa-border"></i></a>
          <!--ko text: sale.name --><!--/ko-->
          &lt;<!--ko text: sale.email --><!--/ko-->&gt;
        </p>
      </div>
      <div class="panel-body" data-bind="visible: admin">
        <form class="form" data-bind="submit: addItem">
          <div class="input-group">
            <span class="input-group-addon"><i class="fa fa-barcode"></i></span>
            <input type="text" class="form-control"
                   name="search" data-bind="value: search"
                   autocomplete="off" autocorrect="off" autocapitalize="off"
                   placeholder="Enter item code or barcode"
                   value="">
            <span class="input-group-btn">
              <input type="submit" class="btn btn-default" value="Add">
            </span>
          </div>
        </form>
      </div>
      <table class="table table-striped">
        <thead>
          <tr>
            <th></th>
            <th class="text-right">Qty</th>
            <th>Code</th>
            <th>Name</th>
            <th class="text-right">Price</th>
            <th class="text-right">Ext</th>
          </tr>
        </thead>
        <tfoot>
          <tr>
            <th colspan="5" class="text-right">Subtotal:</th>
            <td class="text-right" data-bind="text: amount(sale.subtotal())"></td>
          </tr>
          <tr>
            <th colspan="5" class="text-right">
              Shipping &amp; handling:
            </th>
            <td class="text-right" data-bind="text: amount(sale.shipping())"></td>
          </tr>
          <tr>
            <th colspan="5" class="text-right">
              <a data-bind="if: admin(), click: calculateSalesTax">
                <i class="fa fa-calculator"></i></a>
              Estimated tax to be collected:
            </th>
            <td class="text-right" data-bind="text: amount(sale.tax())"></td>
          </tr>
          <tr>
            <th colspan="5" class="text-right">Total:</th>
            <td class="text-right" data-bind="text: amount(sale.total())"></td>
          </tr>
          <!-- ko foreach: payments -->
          <tr>
            <th colspan="5" class="text-right" data-bind="text: $data.method">
              Method:
            </th>
            <td class="text-right" data-bind="text: amount($data.amount())">
              $0.00
            </td>
          </tr>
          <!-- /ko -->
          <tr>
            <th colspan="5" class="text-right">Due:</th>
            <td class="text-right">$0.00</td>
          </tr>
        </tfoot>
        <tbody data-bind="foreach: items">
          <tr valign="top">
            <td><a data-bind="if: $parent.admin, click: $parent.removeItem"><i class="fa fa-trash-o"></i></a></td>
            <td class="text-right" data-bind="text: $data.quantity"></td>
            <td><small data-bind="text: $data.code"></small></td>
            <td>
              <span data-bind="text: $data.name"></span>
              <!-- <br><small>MSRP $19.35</small> -->
            </td>
            <td class="text-right" data-bind="text: amount($data.sale_price())"></td>
            <td class="text-right" data-bind="text: amount($data.sale_price() * $data.quantity())"></td>
          </tr>
        </tbody>
      </table>
      <div class="panel-footer text-right">
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">
          <a data-bind="click: function() { editAddress('billing', billing_address) }">
            <i class="fa fa-address-card-o"></i>
          </a>
          Billing Address
        </h3>
      </div>
      <div class="panel-body" data-bind="with: billing_address">
        <div class="pull-right" data-bind="if: id">
          <button class="btn btn-default btn-xs"
                  data-bind="click: $parent.verifyAddress">
            Verify
          </button>
        </div>
        <div data-bind="text: name"></div>
        <div data-bind="text: address1"></div>
        <div data-bind="text: address2"></div>
        <div data-bind="visible: city, text: city() + ', ' + state() + ' ' + zip5() + (zip4() ? '-' + zip4() : '')"></div>
      </div>
      <div class="panel-heading">
        <h3 class="panel-title">
          <a data-bind="click: function() { editAddress('shipping', shipping_address ) }">
            <i class="fa fa-address-card-o"></i>
          </a>
          Shipping Address
        </h3>
      </div>
      <div class="panel-body" data-bind="with: shipping_address">
        <div data-bind="if: !id() || id() == $parent.billing_address.id()">
          Same as billing address.
        </div>
        <div class="pull-right"
             data-bind="if: id() && iod() != $parent.billing_address.id()">
          <button class="btn btn-default btn-xs"
                  data-bind="click: $parent.verifyAddress">
            Verify
          </button>
        </div>
        <div data-bind="ifnot: id() == $parent.billing_address.id()">
          <div data-bind="text: name"></div>
          <div data-bind="text: address1"></div>
          <div data-bind="text: address2"></div>
          <div data-bind="visible: city, text: city() + ', ' + state() + ' ' + zip4()"></div>
        </div>
      </div>
      <div class="panel-footer text-right">
        <button class="btn btn-primary"
                data-bind="enable: sale.billing_address_id && sale.total,
                           click: prepareForPayment">
          Prepare for payment &raquo;
        </button>
      </div>
    </div>
  </div>

</div>
<include href="footer.html" />
<script>
afterLoad(function() {

  var model= {
    admin: {{ @ADMIN }},
    search: '',
    sale: {{ json_encode(@sale) }},
    person: {{ json_encode(@person) }},
    billing_address: {{ json_encode(@billing_address) }},
    shipping_address: {{ json_encode(@shipping_address) }},
    items: {{ json_encode(@items) }},
    payments: {{ json_encode(@payments) }},
  };

  var viewModel= ko.mapping.fromJS(model);

  viewModel.load= function(sale) {
    ko.mapping.fromJS(sale, viewModel);
  }

  viewModel.addItem= function(form) {
    $.ajax({ dataType: 'json', method: 'POST',
             url: 'add-item',
             data: { item: this.search() } })
     .done(function (data) {
       viewModel.load(data);
     });
  }

  viewModel.removeItem= function(item) {
    $.ajax({ dataType: 'json', method: 'POST',
             url: 'remove-item',
             data: { item: item.id() } })
     .done(function (data) {
       viewModel.load(data);
     });
  }

  viewModel.editPerson= function(person) {
    $.ajax({ url: '{{ @BASE }}/ui/person.html', cache: false })
      .done(function (html) {
        var panel= $(html);

        panel.on('hidden.bs.modal', function() {
          $(this).remove();
        });

        var model= ko.mapping.toJS(person);
        model.error= '';

        var personModel= ko.mapping.fromJS(model);

        personModel.save= function(place, ev) {
          $.ajax({ dataType: 'json', method: 'POST',
                   url: 'set-person',
                   data: ko.mapping.toJS(personModel) })
           .done(function (data) {
             viewModel.load(data);
          });
          $(place).closest('.modal').modal('hide');
        }

        ko.applyBindings(personModel, panel[0]);

        panel.appendTo($('body')).modal();
      });
  }

  viewModel.editAddress= function(type, address) {
    $.ajax({ url: '{{ @BASE }}/ui/address.html', cache: false })
      .done(function (html) {
        var panel= $(html);

        panel.on('hidden.bs.modal', function() {
          $(this).remove();
        });

        var model= ko.mapping.toJS(address);
        model.error= '';
        model.type= type;

        var personModel= ko.mapping.fromJS(model);

        personModel.save= function(place, ev) {
          $.ajax({ dataType: 'json', method: 'POST',
                   url: 'set-address',
                   data: ko.mapping.toJS(personModel) })
           .done(function (data) {
             viewModel.load(data);
          });
          $(place).closest('.modal').modal('hide');
        }

        ko.applyBindings(personModel, panel[0]);

        panel.appendTo($('body')).modal();
      });
  }

  viewModel.verifyAddress= function(data) {
    $.ajax({ dataType: 'json', method: 'POST',
             url: 'verify-address',
             data: ko.mapping.toJS(data) })
     .done(function (data) {
       viewModel.load(data);
    });
  }

  viewModel.calculateSalesTax= function(data) {
    $.ajax({ dataType: 'json', method: 'POST',
             url: 'calculate-sales-tax',
             data: { } })
     .done(function (data) {
       viewModel.load(data);
    });
  }

  viewModel.prepareForPayment= function(data) {
    $.ajax({ dataType: 'json', method: 'POST',
             url: 'set-status',
             data: { status: 'unpaid' } })
     .done(function (data) {
       window.location.href= './';
    });
  }

  ko.applyBindings(viewModel);

});

// format number as $3.00 or ($3.00)
function amount(amount) {
  if (typeof(amount) == 'undefined' || amount == null) {
    return '';
  }
  if (typeof(amount) == 'string') {
    amount= parseFloat(amount);
  }
  if (amount < 0.0) {
    return '($' + Math.abs(amount).toFixed(2) + ')';
  } else {
    return '$' + amount.toFixed(2);
  }
}
</script>

<table class="table table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Quantity</th>
      <th>Code</th>
      <th>Name</th>
      <th class="text-right">Price</th>
      <th class="text-right">Ext</th>
    </tr>
  </thead>
  <tbody>
  <repeat group="{{ @items }}" value="{{ @data }}">
    <tr valign="top">
      <td></td>
<check if="{{ @FEATURE_cart && @sale.status == 'cart' && !@stage}}">
  <true>
      <td class="{{ !@data.stock ? 'has-error' : (@data.stock < @data.quantity ? 'has-warning' : '') }}">
        <check if="{{ @data.kit_id }}">
          <true>
            {{ @data.quantity }}
            <small class="help-block">
              Part of a kit.<br>
          </true>
          <false>
            <div style="width: 6em">
              <div class="input-group input-group-sm">
                <input type="text"
                       class="form-control"
                       name="qty[{{ @data.id }}]" value="{{ @data.quantity }}">
                <span class="input-group-btn">
                  <a href="/cart/remove-item?item={{ @data.id}}"
                     class="btn btn-default">
                    <i class="fa fa-remove"></i>
                  </a>
                </span>
              </div>
            </div>
            <small class="help-block">
            <check if="{{ @data.purchase_quantity > 1 }}">
              <true>
                Must be multiple of {{ @data.purchase_quantity }}.<br>
              </true>
              <false>
                <check if="{{ @CAN_DROPSHIP && (@data.is_dropshippable > 1) }}">
                  Must be multiple of {{ @data.is_dropshippable }} for shipping.<br>
                </check>
              </false>
            </check>
          </false>
        </check>
        <check if="{{ @data.stock }}">
          <true>
            <check if="{{ @data.stock < @data.quantity }}">
              {{ @data.stock }} currently available.
            </check>
          </true>
          <false>
            <check if="{{ @data.minimum_quantity && @data.purchase_quantity }}">
              <true>
                Out of stock.
              </true>
              <false>
                <check if="{{ @data.purchase_quantity }}">
                  Special order item.
                </check>
                <exclude>No purchase quantity means it doesn't have stock.</exclude>
              </false>
            </check>
          </false>
        </check>
      </td>
  </true>
  <false>
      <td>{{ @data.quantity }}</td>
  </false>
</check>
      <td><small>{{ @data.code }}</small></td>
      <td>
        <span>{{ @data.name }}</span>
        <div class="small">{{ @data.detail }}</div>
      </td>
      <check if="{{ @data.kit_id }}">
        <true>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </true>
        <false>
          <td class="text-right">{{ @amount(@data.sale_price) }}</td>
          <td class="text-right">
            {{ @amount(@data.sale_price * @data.quantity) }}
          </td>
        </false>
      </check>
    </tr>
  </repeat>
  </tbody>
  <tfoot>
    <tr>
      <th colspan="3">
<check if="{{ @FEATURE_cart && @sale.status == 'cart' && !@stage}}">
        <button type="submit" class="btn btn-default btn-sm">
          <i class="fa fa-refresh"></i> Update Quantities
        </button>
</check>
      </th>
      <th colspan="2" class="text-right">Subtotal:</th>
      <td class="text-right">{{ @amount(@sale.subtotal) }}</td>
    </tr>
    <tr>
      <check if="{{ ! @sale.shipping_address_id || (@CAN_PICKUP && @sale.shipping_address_id != 1 && @sale.shipping_method === null) }}">
        <true>
          <set shipping_calculated="0">
          <th colspan="5" class="text-right">
            Shipping &amp; handling:
            <check if="{{ @sale.status == 'cart' && @CAN_PICKUP }}">
              <br>or pick up in store for no charge.
            </check>
          </th>
          <td id="shipping" class="text-right text-danger">TBD</td>
        </true>
        <false>
          <set shipping_calculated="1">
          <th colspan="5" class="text-right">
            <check if="{{ @sale.shipping_address_id == 1 }}">
              <true>
                Pickup at store:
              </true>
              <false>
                <check if="{{ @sale.shipping_method == 'bike' }}">
                  <true>
                    Bike delivery:
                  </true>
                  <false>
                    Shipping &amp; handling:
                  </false>
                </check>
              </false>
            </check>
          </th>
          <td class="text-right" id="shipping">
            {{ @amount(@sale.shipping) }}
          </td>
        </false>
      </check>
    </tr>
    <tr>
      <th colspan="5" class="text-right">
<check if="{{ in_array(@sale.status, [ 'cart', 'unpaid', 'review' ]) }}">
  <true>
        Estimated tax:
  </true>
  <false>
        Tax:
  </false>
</check>
      </th>
      <td class="text-right" id="tax">
<check if="{{ @FEATURE_cart && @sale.status == 'cart'
            && !(@shipping_calculated && @sale.tax_calculated) }}">
  <true>
        <span class="text-danger">TBD</span>
  </true>
  <false>
        {{ @amount(@sale.tax) }}
  </false>
</check>
      </td>
    </tr>
    <tr>
      <th colspan="5" class="text-right">Total:</th>
      <td class="text-right" id="total">
<check if="{{ @FEATURE_cart && @sale.status == 'cart'
            && !(@shipping_calculated && @sale.tax_calculated) }}">
  <true>
        <span class="text-danger">TBD</span>
  </true>
  <false>
        {{ @amount(@sale.total) }}
  </false>
</check>
      </td>
    </tr>
    <repeat group="{{ @payments }}" value="{{ @data }}">
      <tr>
        <th colspan="5" class="text-right">
          <check if="{{ @data.method == 'credit' }}">
            Paid by {{ @data.data.cc_brand }}
            ending in {{ @data.data.cc_last4 }}
          </check>
          <check if="{{ @data.method == 'paypal' }}">
            Paid by PayPal
          </check>
          <check if="{{ @data.method == 'amazon' }}">
            Paid with Amazon Pay
          </check>
          <check if="{{ @data.method == 'gift' }}">
            Paid with Gift Card 
          </check>
          <check if="{{ @data.method == 'loyalty' }}">
            Paid with Loyalty Reward ({{ @data.data.points }} points)
          </check>
          <check if="{{ @data.method == 'other' }}">
            Paid
          </check>
          ({{ @data.processed }}):
        </th>
        <td colspan="5" class="text-right">{{ @amount(@data.amount) }}</td>
      </tr>
    </repeat>
    <check if="{{ @sale.status != 'cart' }}">
      <tr>
        <th colspan="5" class="text-right">Due:</th>
        <td class="text-right">{{ @amount(@sale.total - @sale.paid) }}</td>
      </tr>
    </check>
  </tfoot>
</table>

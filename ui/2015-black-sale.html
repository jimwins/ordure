<set title="2015 Montana Black Sale @ Raw Materials Art Supplies" />
<include href="header.html" />
<div class="container">

<form id="order" class="form-inline">

<div class="row">
  <div class="col-sm-8">
    <p class="lead"> Welcome to the 2015 Montana Black Sale at Raw Materials
    Art Supplies.  Place an order for any number of cans and get them for
    $5.00 each, plus tax.  </p>

    <p class="text-danger">All orders must be placed by midnight, July 30,
    2015.  Orders will be ready for pick-up at our store in downtown Los
    Angeles by Friday, August 7. You will be notified by email when your order
    is ready to be picked up. <strong>We are not offering shipping for this
    sale.</strong></p>

    <div class="checkbox">
      <label>
        <input type="checkbox" name="backorder" value="1">
        If any of the colors I've selected are unavailable, please backorder
        them. If you do not backorder the unavailable colors, you will not
        be charged for them.
      </label>
    </div>

  </div>

  <div class="col-sm-4">
    <img class="img-rounded" src="{{ @STATIC }}/catimg/mxb-2070_x.jpg" width="181" height="240" alt="Montana Black Spray Can">
  </div>
</div>

<div id="colors">

<repeat group="{{ @COLORS }}" value="{{ @color }}">
  <div class="form-group">
    <div class="input-group">
      <div class="input-group-addon"
           style="background-color: #{{ @color[0] }};
                  color: #{{ @color[3] }};
                  width: 12em;">
        {{ @color[1] }}
      </div>
      <input style="width: 4em" class="form-control" type="number" min="0" pattern="[0-9]*" name="item[{{ @color[2] }}]"><br>
    </div>
  </div>
</repeat>

</div>

<br>

<button id="purchase" class="btn btn-primary btn-lg">Place Order</button>

<script src="https://checkout.stripe.com/checkout.js"></script>

</form>

</div>
<include href="footer.html" />
<script>

var handler = StripeCheckout.configure({
  key: '{{ @STRIPE_KEY }}',
  image: '{{ @STATIC }}/images/wonton-logo-128x128.jpg',
  token: function(token) {
    // Use the token to create the charge with a server-side script.
    // You can access the token ID with `token.id`

    var data= $('#order').serialize();
    var tok= JSON.stringify(token);

    $.ajax(BASE + 'saveOrder',
           { type : 'POST', data : data + '&token=' + tok + '&amount=' + total } )
          .done(function (data) {
            var d= data;
          })
          .fail(function (jqxhr, textStatus, error) {
            var err= error;
            alert(error);
          });

  }
});

$('#purchase').on('click', function(e) {
  e.preventDefault();

  // Get total number of cans and work out total
  var cans= 0;
  $('#colors input').each(function() {
    cans+= Number($(this).val());
  });

  if (cans == 0) {
    alert("You have to pick some cans up there.");
    return;
  }

  total= (cans * 500) * 1.09;

  // Open Checkout with further options
  handler.open({
    name: 'Raw Materials Art Supplies',
    description: cans + (cans > 1 ? ' cans' : ' can'),
    zipCode: true,
    amount: total
  });
});

$('#order').on('submit', function(e) {
  // XXX write better error message
  alert("Sorry, something is wrong with checking out.");
  e.preventDefault();
});

// Close Checkout on page navigation
$(window).on('popstate', function() {
  handler.close();
});

</script>

